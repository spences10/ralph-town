{
	"$schema": "https://json-schema.org/draft/2020-12/schema",
	"$id": "https://github.com/spences10/ralph-town/ralph.schema.json",
	"title": "Ralph Configuration",
	"description": "Configuration for Ralph Loop orchestration - iterative acceptance criteria with backpressure verification",
	"type": "object",
	"properties": {
		"repository": {
			"type": "object",
			"description": "Git repository to clone and work on",
			"properties": {
				"url": {
					"type": "string",
					"description": "Git clone URL (HTTPS or SSH)",
					"examples": ["https://github.com/user/repo.git"]
				},
				"branch": {
					"type": "string",
					"description": "Branch to clone from",
					"default": "main"
				},
				"working_dir": {
					"type": "string",
					"description": "Subdirectory within repo to work in"
				}
			},
			"required": ["url"]
		},
		"git": {
			"type": "object",
			"description": "Git workflow configuration for commits and PRs",
			"properties": {
				"feature_branch": {
					"type": "string",
					"description": "Branch name for changes",
					"examples": ["feature/add-auth", "fix/login-bug"]
				},
				"commit_author": {
					"type": "string",
					"description": "Git commit author name",
					"default": "Ralph Agent"
				},
				"commit_email": {
					"type": "string",
					"description": "Git commit author email",
					"default": "ralph@example.com"
				},
				"commit_message": {
					"type": "string",
					"description": "Custom commit message (auto-generated if omitted)"
				},
				"create_pr": {
					"type": "boolean",
					"description": "Create PR after all criteria pass",
					"default": false
				},
				"pr_title": {
					"type": "string",
					"description": "PR title (auto-generated if omitted)"
				},
				"pr_body": {
					"type": "string",
					"description": "PR body/description"
				}
			},
			"required": ["feature_branch"]
		},
		"execution": {
			"type": "object",
			"description": "How to run the acceptance criteria",
			"properties": {
				"mode": {
					"type": "string",
					"enum": ["sequential", "parallel"],
					"description": "sequential: one criterion at a time. parallel: multiple concurrent agents",
					"default": "sequential"
				},
				"runtime": {
					"type": "string",
					"enum": ["daytona", "local", "devcontainer"],
					"description": "Execution environment for agents",
					"default": "daytona"
				},
				"max_concurrent": {
					"type": "integer",
					"minimum": 1,
					"maximum": 10,
					"description": "Max parallel agents (parallel mode only)",
					"default": 3
				},
				"model": {
					"type": "string",
					"enum": ["haiku", "sonnet", "opus"],
					"description": "Claude model for agents",
					"default": "haiku"
				}
			}
		},
		"acceptance_criteria": {
			"type": "array",
			"description": "List of criteria that must pass (Ralph pattern)",
			"items": {
				"type": "object",
				"properties": {
					"id": {
						"type": "string",
						"description": "Unique identifier for the criterion",
						"pattern": "^[a-z0-9-]+$",
						"examples": ["ac-001", "feat-auth"]
					},
					"description": {
						"type": "string",
						"description": "Human-readable description of what to achieve"
					},
					"steps": {
						"type": "array",
						"description": "Implementation steps for the agent to follow",
						"items": { "type": "string" },
						"minItems": 1
					},
					"backpressure": {
						"type": "string",
						"description": "Command that must exit 0 for criterion to pass. Should verify actual functionality, not just file existence.",
						"examples": [
							"pnpm run build",
							"npm test && npm run lint",
							"curl -sf http://localhost:3000/health"
						]
					},
					"passes": {
						"type": "boolean",
						"description": "Whether criterion currently passes (updated by orchestrator)",
						"default": false
					}
				},
				"required": ["id", "description", "steps", "backpressure"]
			}
		},
		"max_iterations_per_criterion": {
			"type": "integer",
			"minimum": 1,
			"maximum": 20,
			"description": "Max attempts per criterion before giving up",
			"default": 3
		},
		"budget": {
			"type": "object",
			"description": "Resource limits (Gas Town pattern)",
			"properties": {
				"max_tokens": {
					"type": "integer",
					"minimum": 1000,
					"description": "Maximum tokens across all iterations",
					"examples": [50000, 100000]
				},
				"max_cost_usd": {
					"type": "number",
					"minimum": 0,
					"description": "Maximum cost in USD"
				}
			},
			"required": ["max_tokens"]
		},
		"task": {
			"type": "string",
			"description": "[Legacy] Single task description for simple mode"
		},
		"legacy_criteria": {
			"type": "array",
			"description": "[Legacy] Simple file/command criteria",
			"items": {
				"oneOf": [
					{
						"type": "object",
						"properties": {
							"type": { "const": "file_exists" },
							"path": { "type": "string" }
						},
						"required": ["type", "path"]
					},
					{
						"type": "object",
						"properties": {
							"type": { "const": "command_succeeds" },
							"command": { "type": "string" }
						},
						"required": ["type", "command"]
					}
				]
			}
		},
		"max_iterations": {
			"type": "integer",
			"description": "[Legacy] Max iterations for single-task mode"
		}
	},
	"required": ["budget"],
	"examples": [
		{
			"repository": {
				"url": "https://github.com/user/my-app.git",
				"branch": "main"
			},
			"git": {
				"feature_branch": "feature/add-auth",
				"create_pr": true
			},
			"execution": {
				"mode": "parallel",
				"max_concurrent": 3,
				"model": "haiku"
			},
			"acceptance_criteria": [
				{
					"id": "ac-001",
					"description": "Add user authentication",
					"steps": [
						"Install auth dependencies",
						"Create auth middleware",
						"Add login/logout routes",
						"Run tests"
					],
					"backpressure": "npm run build && npm test",
					"passes": false
				}
			],
			"max_iterations_per_criterion": 3,
			"budget": {
				"max_tokens": 50000
			}
		}
	]
}
